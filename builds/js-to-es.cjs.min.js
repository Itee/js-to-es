"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function isString(e){return"string"==typeof e}function isNotString(e){return!isString(e)}function isArrayOfString(e){if(!Array.isArray(e))return!1;for(var t=0,r=e.length;t<r;t++)if(isNotString(e[t]))return!1;return!0}function fileExistForPath(e){return fs.existsSync(e)}function fileNotExistForPath(e){return!fileExistForPath(e)}function getFileForPath(e){if(fileNotExistForPath(e))throw new Error('Invalid file path "'.concat(e,'" file does not exist !'));return fs.readFileSync(e,"utf8")}function getUncommentedFileForPath(e){return getFileForPath(e).replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*(?<!(\\n\\|",|',|";|';))$/gm,"$1")}function createFoldersTree(e){e.split(path.sep).reduce(function(e,t){var r=path.join(e,t);return fileNotExistForPath(r)&&fs.mkdirSync(r),r})}function makeUnique(e,t,r){return r.indexOf(e)===t}Object.defineProperty(exports,"__esModule",{value:!0});var fs=require("fs"),path=require("path");String.prototype.contains=String.prototype.contains||function(e){return this.indexOf(e)>-1};var JsToEs=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.inputs=t.inputs||[""],this.excludes=t.excludes||[""],this.output=t.output||"",this.edgeCases=t.edgeCases||[],this.banner=t.banner||"",this.namespace=t.namespace||"",this._exportMap={},this._fileMap={},this._regex={AMD:new RegExp(/define\.amd/g),CJS:new RegExp(/module\.exports\s*=\s*\{?[^}]*}?/g),UMD:new RegExp(/\(function\s*\(root,\s*factory\)\s*\{/g),Classic:new RegExp("(".concat(this._namespace,".(\\w+)\\s*=\\s*)+\\s*function"),"g"),Prototype:new RegExp("prototype\\.constructor\\s?=\\s?(".concat(this._namespace,"\\.)?(\\w)+"),"g"),Library:new RegExp("".concat(this._namespace,".(\\w+) = \\{")),Es6:new RegExp(/(export\s(default|var))|((import|export)[\r\n\s]*(default)?({[\w\s,]+}\s?(from)?))/,"g")}}return _createClass(e,[{key:"setInputs",value:function(e){return this.inputs=e,this}},{key:"setExcludes",value:function(e){return this.excludes=e,this}},{key:"setOutput",value:function(e){return this.output=e,this}},{key:"setEdgeCases",value:function(e){return this.edgeCases=e,this}},{key:"setBanner",value:function(e){return this.banner=e,this}},{key:"setNamespace",value:function(e){return this.namespace=e,this}},{key:"convert",value:function(t){function r(){var t=this._inputs,r=this._excludes,n=this._output,a=this._edgeCases,s=this._banner,o=this._namespace,i=this._regex,p=e._getFilesPathsUnder(t).filter(makeUnique),c=e._excludesFilesPaths(p,r),u=e._filterJavascriptFiles(c);this._exportMap=e._createExportMap(u,o,i,a,t,n),this._fileMap=e._createFilesMap(o,i,c,this._exportMap,a,t,n),e._processFiles(this._fileMap,this._exportMap,s)}var n=this;if(!t)return new Promise(function(e,t){try{r.call(n),e()}catch(e){t(e)}});try{r.call(this),t()}catch(e){t(e)}}},{key:"inputs",get:function(){return this._inputs},set:function(e){if(isArrayOfString(e))this._inputs=e;else{if(!isString(e))throw new TypeError("Invalid inputs arguments, expected a String or Array of String");this._inputs=[e]}}},{key:"excludes",get:function(){return this._excludes},set:function(e){if(isArrayOfString(e))this._excludes=e;else{if(!isString(e))throw new TypeError("Invalid excludes arguments, expected a String or Array of String");this._excludes=[e]}return this}},{key:"output",get:function(){return this._output},set:function(e){if(!isString(e))throw new TypeError("Invalid output arguments, expected a String");return this._output=e,this}},{key:"edgeCases",get:function(){return this._edgeCases},set:function(e){this._edgeCases=e}},{key:"banner",get:function(){return this._banner},set:function(e){if(isNotString(e))throw new TypeError("Invalid banner argument, expect a string.");this._banner=e}},{key:"namespace",get:function(){return this._namespace},set:function(e){if(isNotString(e))throw new TypeError("Invalid namespace argument, expect a string.");this._namespace=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),this._regex={AMD:new RegExp(/define\.amd/g),CJS:new RegExp(/module\.exports\s*=\s*\{?[^}]*}?/g),UMD:new RegExp(/\(function\s*\(root,\s*factory\)\s*\{/g),Classic:new RegExp("(".concat(this._namespace,".(\\w+)\\s*=\\s*)+\\s*function"),"g"),Prototype:new RegExp("prototype\\.constructor\\s?=\\s?(".concat(this._namespace,"\\.)?(\\w)+"),"g"),Library:new RegExp("".concat(this._namespace,".(\\w+) = \\{")),Es6:new RegExp(/(export\s(default|var))|((import|export)[\r\n\s]*(default)?({[\w\s,]+}\s?(from)?))/,"g")}}},{key:"exportMap",get:function(){return this._exportMap}},{key:"fileMap",get:function(){return this._fileMap}}],[{key:"_getFilesPathsUnder",value:function(t){var r=[];if(Array.isArray(t))for(var n=void 0,a=0,s=t.length;a<s;a++){n=t[a];var o=e._checkStateOf(n);Array.prototype.push.apply(r,o)}else{var i=e._checkStateOf(t);Array.prototype.push.apply(r,i)}return r}},{key:"_getFilesPathsUnderFolder",value:function(t){var r=[];return fs.readdirSync(t).forEach(function(n){var a=path.resolve(t,n),s=e._checkStateOf(a);Array.prototype.push.apply(r,s)}),r}},{key:"_checkStateOf",value:function(t){if(fileNotExistForPath(t))throw new ReferenceError('Invalid file path "'.concat(t,'".'));var r=fs.statSync(t);if(r.isFile())return[t];if(r.isDirectory())return e._getFilesPathsUnderFolder(t);throw new ReferenceError("Invalid stats file object.")}},{key:"_filterJavascriptFiles",value:function(e){for(var t=[],r=void 0,n=0,a=e.length;n<a;n++)r=e[n],".js"===path.extname(r)&&t.push(r);return t}},{key:"_excludesFilesPaths",value:function(t,r){for(var n=[],a=void 0,s=0,o=t.length;s<o;s++)a=t[s],e._isExclude(a,r)||n.push(a);return n}},{key:"_isExclude",value:function(e,t){for(var r=!1,n=void 0,a=0,s=t.length;a<s;a++)0!==(n=t[a]).length&&(n.indexOf(".")>-1?e.replace(/^.*(\\|\/|\:)/,"")===n&&(r=!0):e.contains(n)&&(r=!0));return r}},{key:"_getFileType",value:function(t,r){var n=t.match(r[e.JavascriptType.Es6]);if(n&&n.length>0)return e.JavascriptType.Es6;var a=t.match(r[e.JavascriptType.AMD]);if(a&&a.length>0)return e.JavascriptType.AMD;var s=t.match(r[e.JavascriptType.CJS]);if(s&&s.length>0)return e.JavascriptType.CJS;var o=t.match(r[e.JavascriptType.Classic]);if(o&&o.length>0)return e.JavascriptType.Classic;var i=t.match(r[e.JavascriptType.Prototype]);if(i&&i.length>0)return e.JavascriptType.Prototype;var p=t.match(r[e.JavascriptType.Library]);return p&&p.length>0?e.JavascriptType.Library:e.JavascriptType.Unknown}},{key:"_convertFile",value:function(t,r,n){var a=r.output,s=path.dirname(a),o=t+e._formatImportStatements(a,n,r.imports)+e._formatReplacementStatements(r.file,r.replacements)+e._formatExportStatements(a,r.exports);createFoldersTree(s),fs.writeFileSync(a,o)}},{key:"_copyFile",value:function(e,t){var r=t.output,n=path.dirname(r),a=e+t.file;createFoldersTree(n),fs.writeFileSync(r,a)}},{key:"_getAllImportsFromExportsIn",value:function(e,t,r,n){var a=[];for(var s in n)if(!r.includes(s)){var o=new RegExp("(".concat(s,")(?=(?:[^\"'\\]*(?:\\.|[\"'](?:[^\"'\\]*\\.)*[^\"'\\]*[\"']))*[^\"']*$)"));null!==t.match(o)&&a.push(s)}return a}},{key:"_getAllImportsStatementIn",value:function(e,t,r){var n=[];return(t.match(/import\s+(?:(?:({[\w\s,]+})|([\w,*-]+))\s+)+from/g)||[]).filter(makeUnique).forEach(function(e){for(var t=e.replace("import","").replace("from","").replace(/[{}]/g,"").replace(/\s+/g,"").split(","),a=void 0,s=t.length-1;s>=0;--s){if(a=t[s],r.includes(a))return;a||t.splice(s,1)}t.length>0&&Array.prototype.push.apply(n,t)}),n}},{key:"_getAllExtendsStatementIn",value:function(e,t,r){var n=[],a=new RegExp("Object\\.assign\\(\\s*((".concat(e,".)?(\\w+)\\.prototype[,]*\\s*){2,}"),"g"),s=new RegExp("".concat(e,"\\."),"g");return(t.match(a)||[]).filter(makeUnique).forEach(function(e){for(var t=e.replace(/Object\.assign\(\s+/g,"").replace(s,"").replace(/\.prototype/g,"").replace(/\s+/g,"").split(","),a=void 0,o=t.length-1;o>=0;--o)(a=t[o])&&!r.includes(a)||t.splice(o,1);t.length>0&&Array.prototype.push.apply(n,t)}),n}},{key:"_getAllInheritStatementsIn",value:function(e,t,r){var n=[],a=new RegExp("Object\\.create\\(\\s+((".concat(e,".)?(\\w+)\\.prototype[,]?\\s*)+\\)"),"g"),s=new RegExp("Object\\.create\\(\\s+(".concat(e,".)?"),"g");return(t.match(a)||[]).filter(makeUnique).forEach(function(e){for(var t=e.replace(s,"").replace(/\.prototype/g,"").replace(/\)/g,"").replace(/\s+/g,"").split(","),a=void 0,o=0,i=t.length;o<i;o++)(a=t[o])&&!r.includes(a)||t.splice(o,1);t.length>0&&Array.prototype.push.apply(n,t)}),n}},{key:"_getAllNewStatementIn",value:function(e,t,r){var n=[],a=new RegExp("new\\s".concat(e,".(\\w+)\\s?"),"g"),s=new RegExp("new\\s".concat(e,"\\."),"g");return(t.match(a)||[]).filter(makeUnique).forEach(function(e){var t=e.replace(s,"").replace(/\s+/g,"");r.includes(t)||t&&n.push(t)}),n}},{key:"_getAllInstanceOfStatementIn",value:function(e,t,r){var n=[],a=new RegExp("instanceof\\s".concat(e,".(\\w+)\\s?"),"g"),s=new RegExp("instanceof\\s".concat(e,"\\."),"g");return(t.match(a)||[]).filter(makeUnique).forEach(function(e){var t=e.replace(s,"").replace(/\s+/g,"");r.includes(t)||t&&n.push(t)}),n}},{key:"_getImportsFor",value:function(t,r,n,a,s){if(s.importsOverride)return s.importsOverride;var o=[];return Array.prototype.push.apply(o,e._getAllImportsFromExportsIn(t,r,n,a)),s.imports&&Array.prototype.push.apply(o,s.imports),o.filter(makeUnique)}},{key:"_formatImportStatements",value:function(e,t,r){var n=[],a={};r.forEach(function(r){if(Array.isArray(r))a[r[2]]=[],a[r[2]].push(r[0]);else{var n=t[r];if(!n)return void console.error("WARNING: Missing export of ".concat(r,", required in ").concat(e,". This is an edge case that will probably need to be managed manually !!!"));var s=path.dirname(e),o=path.dirname(n),i=path.basename(n),p=path.relative(s,o),c=("."!==p[0]?"./"+path.join(p,i):path.join(p,i)).replace(/\\/g,"/");a[c]||(a[c]=[]),a[c].push(r)}});for(var s in a){var o=a[s],i="import {";if(1===o.length)i+=" ".concat(o[0]," ");else if(o.length>1){i+="\n";for(var p=void 0,c=0,u=o.length;c<u;c++)p=o[c],i+=c===u-1?"\t".concat(p,"\n"):"\t".concat(p,",\n")}else console.error("WARNING: ".concat(path.basename(s)," does not contains imports, fallback to file name export..."));i+="} from '".concat(s,"'"),n.push(i)}return n.join("\n").concat("\n\n")}},{key:"_getEs6ReplacementsFor",value:function(e){var t=[];return t.push([/import\s+(?:(?:({[\w\s,]+})|([\w,*-]+))\s+)+from.+/g,""]),t.push([/export var/g,"var"]),t.push([/export function/g,"function"]),t.push([/export(?:[^s]|)(\s*{(?:[\w\s,])+}\s*)(?:(?:from)?\s?['"][.\/]+[\w.]+['"])?;?/g,""]),t}},{key:"_getExportsReplacementsFor",value:function(e,t){for(var r=[],n=0,a=t.length;n<a;n++){var s=t[n],o=new RegExp("".concat(e,".").concat(s," ="),"g"),i="var ".concat(s," =");r.push([o,i]);var p=new RegExp(" = var ","g");r.push([p," = "])}return r}},{key:"_getIifeReplacementsFor",value:function(e,t){var r=t.replace(/\s+/g,""),n=[];if((r.match(/^\(\s*function\s*\(\s*(\w+)?\s*\)\s*\{/g)||[]).length>0){n.push([/\(\s*function\s*\(\s*(\w+)?\s*\)\s*\{/,""]);var a=r.match(/}\s*\)\s*\(\s*[\w.=\s]*(\|\|\s*\{\})?\s*\);?$/)||[],s=r.match(/}\s*\(\s*[\w]*\s*\)\s*\);?$/)||[];if(a.length>0)n.push([/}\s*\)\s*\(\s*[\w.=\s]*(\|\|\s*\{\})?\s*\);?/,""]);else{if(!(s.length>0))throw new Error("Unable to match end of IIFE.");n.push([/}\s*\(\s*[\w]*\s*\)\s*\);?/,""])}}return n}},{key:"_getNamespaceReplacementsFor",value:function(e){return[[new RegExp("".concat(e,"\\.Math\\."),"g"),"_Math."],[new RegExp("".concat(e,"\\."),"g"),""]]}},{key:"_getAutoAssignementReplacementsFor",value:function(e){return[[/var\s?(\w+)\s?=\s?\1;/g,""]]}},{key:"_getReplacementsFor",value:function(t,r,n,a){if(a.replacementsOverride)return a.replacementsOverride;var s=[];return Array.prototype.push.apply(s,e._getEs6ReplacementsFor(t)),Array.prototype.push.apply(s,e._getExportsReplacementsFor(t,n)),Array.prototype.push.apply(s,e._getIifeReplacementsFor(t,r)),Array.prototype.push.apply(s,e._getNamespaceReplacementsFor(t)),Array.prototype.push.apply(s,e._getAutoAssignementReplacementsFor(t)),a.replacements&&Array.prototype.push.apply(s,a.replacements),s}},{key:"_formatReplacementStatements",value:function(e,t){for(var r=e,n=0,a=t.length;n<a;n++){var s=t[n];r=r.replace(s[0],s[1])}return r}},{key:"_getExportsStatementsInES6File",value:function(e,t){var r=[],n=t.match(/export(?:[^s]|)(?:(?:\s*{([\w\s,]+)}\s*)(?:(?:from)?\s?['"]([.\/]+[\w.]+['"]);?)?|(var\s+.+))/g);return n&&n.forEach(function(e){if(e.contains("from")){var t=e.split("from"),n=t[0].replace(/export/g,"").replace(/[\s\n\r;{}]+/g,""),a=t[1].replace(/[\s'";]+/g,"");return void Array.prototype.push.apply(r,[[n,"from",a]])}e.contains("as")&&(e=e.replace(/\w+\sas/g,"")),e.contains("var")&&(e=e.replace(/export/g,"").replace(/var/g,"").replace(/\s*=\s*.+/g,"")),e.contains("function")&&(e=e.replace(/function/g,""));var s=e.replace(/export/g,"").replace(/[\s\n\r;{}]+/g,"").split(",");Array.prototype.push.apply(r,s)}),r}},{key:"_getExportsStatementsInAMDFile",value:function(e,t){return console.error("WARNING: File is unable to be process... It is an AMD module. Sorry for the disagreement."),[]}},{key:"_getExportsStatementsInCJSFile",value:function(e,t){var r=[],n=new RegExp(/module\.exports\s*=\s*\{?[^}]*}?/g),a=t.match(n);return a&&a.forEach(function(e){var t=e.replace(/module\.exports/g,"").replace(/[\s\n\r;{}=]+/g,"").split(",");Array.prototype.push.apply(r,t)}),r}},{key:"_getExportsStatementsInClassicFile",value:function(e,t){var r=[],n=new RegExp("(".concat(e,".(\\w+)\\s*=\\s*)+\\s*function"),"g"),a=new RegExp("".concat(e,"\\.|\\s*=\\s*function"),"g"),s=t.match(n);return s&&s.forEach(function(e){var t=e.replace(a,"").replace(/\s*/g,"").split("=");Array.prototype.push.apply(r,t)}),r}},{key:"_getExportsStatementsInPrototypedFile",value:function(e,t){var r=[],n=new RegExp("prototype\\.constructor\\s?=\\s?(".concat(e,"\\.)?(\\w)+"),"g"),a=new RegExp("".concat(e,"\\."),"g"),s=t.match(n);return s&&s.forEach(function(e){var t=e.replace(/prototype\.constructor\s?=\s?/g,"").replace(a,"");r.push(t)}),r}},{key:"_getExportsStatementInLibraryFile",value:function(e,t){var r=[],n=new RegExp("".concat(e,".(\\w+) = \\{"),"g"),a=new RegExp("".concat(e,"\\.| = \\{"),"g"),s=t.match(n);return s&&s.forEach(function(e){var t=e.replace(a,"");r.push(t)}),r}},{key:"_getExportsFor",value:function(t,r,n,a,s){if(s.exportsOverride)return s.exportsOverride;var o=void 0;switch(r){case e.JavascriptType.AMD:o=e._getExportsStatementsInAMDFile(t,n);break;case e.JavascriptType.CJS:o=e._getExportsStatementsInCJSFile(t,n);break;case e.JavascriptType.Classic:o=e._getExportsStatementsInClassicFile(t,n);break;case e.JavascriptType.Es6:o=e._getExportsStatementsInES6File(t,n);break;case e.JavascriptType.Library:o=e._getExportsStatementInLibraryFile(t,n);break;case e.JavascriptType.Prototype:o=e._getExportsStatementsInPrototypedFile(t,n);break;case e.JavascriptType.UMD:case e.JavascriptType.Unknown:console.error("WARNING: ".concat(a," does not contains explicit or implicit export, fallback to file name as export...")),o=[a];break;default:throw new RangeError("Invalid switch parameter: ".concat(r))}return s.exports&&Array.prototype.push.apply(o,s.exports),o.filter(makeUnique)}},{key:"_formatExportStatements",value:function(e,t){var r="",n=[],a=[];if(t.forEach(function(e){Array.isArray(e)?n.push(e):a.push(e)}),0===n.length&&0===a.length)return console.error("WARNING: ".concat(path.basename(e)," does not contains explicit or implicit export, fallback to file name export... It must be an Es6 file with it own exports !")),"";for(var s=0,o=n.length;s<o;s++){var i=n[s],p=(i[0],i[1]),c=i[2];if("from"===p)r+="export { ".concat(i[0],' } from "').concat(c,'"\n');else{if("as"!==p)throw new Error("Invalid specified export action !");r+="export { ".concat(i[0]," as ").concat(c," }\n")}}var u=a.length;if(1===u)r+="\nexport { ".concat(t[0]," }\n");else if(u>1){r+="\nexport {\n";for(var l=0;l<u;l++)r+=l===u-1?"\t"+a[l]+"\n":"\t"+a[l]+",\n";r+="}\n"}return r}},{key:"_getOutputFor",value:function(t,r,n,a){if(a.outputOverride)return path.join(n,a.outputOverride);var s=e._getSpecificPath(r,n,t);return path.join(n,s)}},{key:"_getSpecificPath",value:function(e,t,r){for(var n=r.split(path.sep),a=0,s=0,o=e.length;s<o;s++){for(var i=e[s].split(path.sep),p=0;i[p]===n[p];)p++;p>a&&(a=p)}return n.slice(a).join(path.sep)}},{key:"_createFilesMap",value:function(t,r,n,a,s,o,i){var p={};return n.forEach(function(n){var c=path.extname(n),u=path.basename(n,c);if(p[u])return void console.error("WARNING: The file ".concat(u," already exist in the file map ! Is there a duplicated file ???"));var l=getUncommentedFileForPath(n),f=".js"===c,h=s[u]||{};if(f){var g=e._getFileType(l,r),y=e._getExportsFor(t,g,l,u,h),v=e._getImportsFor(t,l,y,a,h),m=e._getReplacementsFor(t,l,y,h),x=e._getOutputFor(n,o,i,h);p[u]={isJavascript:f,fileType:g,file:l,imports:v,replacements:m,exports:y,output:x}}else{var d=e._getOutputFor(n,o,i,h);p[u]={isJavascript:f,file:l,output:d}}}),p}},{key:"_createExportMap",value:function(t,r,n,a,s,o){var i={};return t.forEach(function(t){var p=path.extname(t),c=path.basename(t,p),u=a[c]||{},l=getUncommentedFileForPath(t),f=e._getFileType(l,n),h=e._getExportsFor(r,f,l,c,u),g=e._getOutputFor(t,s,o,u);h.forEach(function(e){Array.isArray(e)&&(e=e[0]);var r=i[e];if(r)return void console.error('WARNING: Element "'.concat(e,'" in ').concat(t," is already exported by ").concat(r,"! Unable to determine which source file is the right exporter !!!"));i[e]=g})}),i}},{key:"_processFiles",value:function(t,r,n){for(var a in t)if(t.hasOwnProperty(a)){var s=t[a];s.isJavascript?e._convertFile(n,s,r):e._copyFile(n,s)}}}]),e}();_defineProperty(JsToEs,"JavascriptType",Object.freeze({AMD:"AMD",CJS:"CJS",Classic:"Classic",Es6:"Es6",Library:"Library",Prototype:"Prototype",UMD:"UMD",Unknown:"Unknown"})),exports.JsToEs=JsToEs;
